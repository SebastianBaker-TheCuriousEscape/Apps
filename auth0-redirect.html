<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Auth0 Redirect</title>
</head>
<body>
<script>
// -----------------------------------------------------
// 1. Store PKCE code_verifier (must match challenge)
// -----------------------------------------------------
localStorage.setItem("pkce_verifier",
"p9K3xZQ7u1mC8rT2sF5bN0vH4yW6dJ3qL8pR1tE9gU7kM2cA5xS0zV4nB6fY");

// -----------------------------------------------------
// 2. Extract the ?code= from Auth0 redirect
// -----------------------------------------------------
const params = new URLSearchParams(window.location.search);
const authCode = params.get("code");

if (!authCode) {
    window.AppInventor.setWebViewString(JSON.stringify({
        error: "missing_code",
        message: "No authorization code found in redirect URL."
    }));
    throw new Error("No authorization code");
}

// -----------------------------------------------------
// 3. Retrieve PKCE verifier
// -----------------------------------------------------
const codeVerifier = localStorage.getItem("pkce_verifier");

if (!codeVerifier) {
    window.AppInventor.setWebViewString(JSON.stringify({
        error: "missing_verifier",
        message: "PKCE code_verifier not found in localStorage."
    }));
    throw new Error("Missing PKCE verifier");
}

// -----------------------------------------------------
// 4. Exchange authorization code for tokens
// -----------------------------------------------------
async function exchangeCode() {
    try {
        const tokenResponse = await fetch("https://thecuriousescape.au.auth0.com/oauth/token", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                grant_type: "authorization_code",
                client_id: "b1PuALfSK0dM8HpdpS0jLt7gZLnm0d5d",
                code_verifier: codeVerifier,
                code: authCode,
                redirect_uri: "https://sebastianbaker-thecuriousescape.github.io/Apps/auth0-redirect.html"
            })
        });

        const tokens = await tokenResponse.json();

        // -----------------------------------------------------
        // 5. Fetch user profile using access_token
        // -----------------------------------------------------
        const userinfoResponse = await fetch("https://thecuriousescape.au.auth0.com/userinfo", {
            headers: {
                "Authorization": "Bearer " + tokens.access_token
            }
        });

        const profile = await userinfoResponse.json();

        // -----------------------------------------------------
        // 6. Send tokens + decoded profile back to App Inventor
        // -----------------------------------------------------
        window.AppInventor.setWebViewString(JSON.stringify({
            access_token: tokens.access_token,
            id_token: tokens.id_token,
            refresh_token: tokens.refresh_token,
            profile: profile
        }));

    } catch (err) {
        window.AppInventor.setWebViewString(JSON.stringify({
            error: "token_or_profile_failed",
            message: err.message
        }));
    }
}

exchangeCode();
</script>
</body>
</html>
