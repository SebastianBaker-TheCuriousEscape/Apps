<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Auth0 Redirect</title>
</head>
<body>
<script>
// -----------------------------
// 1. Extract ?code= from URL
// -----------------------------
const params = new URLSearchParams(window.location.search);
const authCode = params.get("code");

if (!authCode) {
    window.AppInventor.setWebViewString(JSON.stringify({
        error: "missing_code",
        message: "No authorization code found in redirect URL."
    }));
    throw new Error("No authorization code");
}

// -----------------------------
// 2. Retrieve stored PKCE verifier
// -----------------------------
const codeVerifier = localStorage.getItem("pkce_verifier");

if (!codeVerifier) {
    window.AppInventor.setWebViewString(JSON.stringify({
        error: "missing_verifier",
        message: "PKCE code_verifier not found in localStorage."
    }));
    throw new Error("Missing PKCE verifier");
}

// -----------------------------
// 3. Exchange code for tokens
// -----------------------------
async function exchangeCode() {
    try {
        const response = await fetch("https://thecuriousescape.au.auth0.com/oauth/token", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                grant_type: "authorization_code",
                client_id: "YOUR_CLIENT_ID",
                code_verifier: codeVerifier,
                code: authCode,
                redirect_uri: "https://YOUR_DOMAIN/auth0-redirect.html"
            })
        });

        const data = await response.json();

        // -----------------------------
        // 4. Send tokens back to App Inventor
        // -----------------------------
        window.AppInventor.setWebViewString(JSON.stringify(data));

    } catch (err) {
        window.AppInventor.setWebViewString(JSON.stringify({
            error: "token_exchange_failed",
            message: err.message
        }));
    }
}

exchangeCode();
</script>
</body>
</html>
